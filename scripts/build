#!/usr/bin/env bash
set -e

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
WORK_DIR=$(realpath "${SCRIPT_DIR}/..")
WEB_DIR="${WORK_DIR}/web"
BUILD_DIR="${WORK_DIR}/build"
WEB_BUILD_DIR="${BUILD_DIR}/web"
MDI_DIR="${WEB_DIR}/node_modules/@material-design-icons/svg/outlined"
ANDROID_ASSETS_DIR="${WORK_DIR}/android/src/main/assets"

echo
echo "======================== Building Web app =========================="
echo

rm -rf ${WEB_BUILD_DIR}
mkdir -p ${WEB_BUILD_DIR}
cd ${WEB_DIR}
npm install

# Get last commit date and short commit hash
COMMIT_DATE=$(git log -1 --format=%cd --date=format:%Y-%m-%d)
COMMIT_HASH=$(git rev-parse --short HEAD)
VERSION="${COMMIT_DATE}-${COMMIT_HASH}"
sed "s#%VERSION%#${VERSION}#g" index.html > \
    ${WEB_BUILD_DIR}/index.html

rm -rf ${WEB_BUILD_DIR}/dist
mkdir -p ${WEB_BUILD_DIR}/dist

cp \
    ${WEB_BUILD_DIR}/index.html \
    main.cljs \
    node_modules/bootstrap/dist/css/bootstrap.css \
    node_modules/react/umd/react.production.min.js \
    node_modules/react-dom/umd/react-dom.production.min.js \
    node_modules/scittle/dist/scittle.js \
    node_modules/scittle/dist/scittle.reagent.js \
    ${MDI_DIR}/file_download.svg \
    ${MDI_DIR}/file_upload.svg \
    ${WEB_BUILD_DIR}/dist

echo
echo "====================== Building Android app ========================"
echo

# Include web app into Android project
rm -rf ${ANDROID_ASSETS_DIR}/web
cp -r ${WEB_BUILD_DIR}/dist ${ANDROID_ASSETS_DIR}/web

cd "${WORK_DIR}"
gradle \
    -Dorg.gradle.project.android.aapt2FromMavenOverride=${AAPT2:?} \
    build
